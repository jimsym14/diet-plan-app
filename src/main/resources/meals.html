<!DOCTYPE html>
<html>
<head>
    <title>Your Diet Plan</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
    </style>
</head>
<body class="meals-page">
    <div class="top-banner">
        <button class="nav-btn" onclick="goBack()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="back-icon">
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
            </svg>
            Back
        </button>
        <div class="nutrition-stats">
            <div class="total-calories">
                <span class="calorie-value">2000</span>
                <span class="2000 calorie-label">kcal Remaining</span>
            </div>
            <div class="macro-pill protein">
                <span class="macro-label">Protein:</span>
                <span class="macro-value">0g/120g</span>
            </div>
            <div class="macro-pill carbs">
                <span class="macro-label">Carbs:</span>
                <span class="macro-value">0g/250g</span>
            </div>
            <div class="macro-pill fat">
                <span class="macro-label">Fat:</span>
                <span class="macro-value">0g/65g</span>
            </div>
        </div>
        <button class="nav-btn finish-btn">Finish Plan</button>
    </div>

    <div class="day-selector-vertical">
        <button class="day-btn" data-day="MO">MO</button>
        <button class="day-btn" data-day="TU">TU</button>
        <button class="day-btn" data-day="WE">WE</button>
        <button class="day-btn" data-day="TH">TH</button>
        <button class="day-btn" data-day="FR">FR</button>
        <button class="day-btn" data-day="SA">SA</button>
        <button class="day-btn" data-day="SU">SU</button>
    </div>

    <div class="title-section">
        <h1 class="main-title">Personal Meal Planner</h1>
        <p class="subtitle">Customize your weekly nutrition plan with our handpicked selection of healthy meals</p>
    </div>
    
    <div class="search-wrapper">
        <div class="search-container">
            <input type="text" placeholder="Search for foods...">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>
        <button class="filters-btn">
            <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Filters
        </button>
    </div>
    
    <div class="meal-container" id="mealContainer">
        <!-- Î•Î´Ï Î¸Î± ÎµÎ¹ÏƒÎ±Ï‡Î¸Î¿ÏÎ½ Î¿Î¹ ÎºÎ¬ÏÏ„ÎµÏ‚ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½ Î¼Îµ JavaScript -->
    </div>
    
    <script>
        // Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ console.log Î³Î¹Î± Ï€Î±ÏÎ±Î³Ï‰Î³Î®
        console.log = function() {};
        let bridge = null;
        let isDebugMode = false;
        let currentDay = "MO";
        let allMealsData = [];
        let localSelections = {}; 
        let dailyCalories = {}; 
        let dailyProtein = {}; 
        let dailyCarbs = {}; 
        let dailyFat = {};
        
        //Default Ï„Î¹Î¼Î­Ï‚
        let DEFAULT_DAILY_CALORIES = 2000;
        let DEFAULT_PROTEIN_GOAL = 120;
        let DEFAULT_CARBS_GOAL = 250;
        let DEFAULT_FAT_GOAL = 65;

        // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î´Î¹Î±Ï„ÏÎ¿Ï†Î¹ÎºÏÎ½ Ï„Î¹Î¼ÏÎ½ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î·Î¼Î­ÏÎ±
        function initLocalSelections() {
            const days = ["MO", "TU", "WE", "TH", "FR", "SA", "SU"];
            days.forEach(day => {
                if (!localSelections[day]) {
                    localSelections[day] = [];
                }
                if (dailyCalories[day] === undefined) dailyCalories[day] = DEFAULT_DAILY_CALORIES;
                if (dailyProtein[day] === undefined)  dailyProtein[day]  = 0;
                if (dailyCarbs[day] === undefined)    dailyCarbs[day]    = 0;
                if (dailyFat[day] === undefined)      dailyFat[day]      = 0;
            });
        }

        function showError(message) {
            // ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½ ÏƒÏ„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î±
            console.error(`[ERROR] ${message}`);
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Ï…Ï‡Î±Î¯ÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î·Î¼Î­ÏÎ± Ï„Î·Ï‚ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±Ï‚
        function generateRandomSelections() {
            if (!Array.isArray(allMealsData) || allMealsData.length === 0) return;
            const days = ["MO","TU","WE","TH","FR","SA","SU"];
            // Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± IDs ÎºÎ±Î¹ Î±Î½Î±ÎºÎ±Ï„ÎµÏÎ¿Ï…Î¼Îµ Î¼Î¯Î± Ï†Î¿ÏÎ¬
            const ids = allMealsData.map(m => m.id);
            const shuffled = [...ids];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            // Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶Î¿Ï…Î¼Îµ Ï€ÏŒÏƒÎ± Î³ÎµÏÎ¼Î±Ï„Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±
            const countPerDay = Math.max(1, Math.floor(shuffled.length / days.length));
            // ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î´Î¹Î±Î´Î¿Ï‡Î¹ÎºÏÎ½ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î·Î¼Î­ÏÎ±
            days.forEach((day, idx) => {
                const start = idx * countPerDay;
                const slice = shuffled.slice(start, start + countPerDay);
                localSelections[day] = slice;
            });
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï„Î·Ï‚ Java Î³Î¹Î± Ï„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ 
        function setupPage(mealsData, initialDay, initialSelectedIds) {
            if (Array.isArray(mealsData) && mealsData.length > 0) {
                if (Array.isArray(initialSelectedIds)) {
                }

                try {
                    allMealsData = parseJSONorArray(mealsData.length === undefined ? mealsData : JSON.stringify(mealsData));
                    localSelections[initialDay] = parseJSONorArray(initialSelectedIds);

                    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡Î¹ÎºÎ­Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Ï„Ï…Ï‡Î±Î¯ÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î·Î¼Î­ÏÎ±
                    if (!Array.isArray(initialSelectedIds) || parseJSONorArray(initialSelectedIds).length === 0) {
                        generateRandomSelections();
                    }
                    currentDay = initialDay;
                    
                    createMealCards(allMealsData); 
                    updateSelectedCards(localSelections[currentDay]);
                    updateSelectedDayButton(currentDay);
                    updateDailyCaloriesDisplay();

                } catch (e) {
                    showError(`Error during setupPage: ${e.message}`);
                    console.error(e);
                }
            }
        }
        
        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±ÏÏ„ÏÎ½ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½ Î¼Îµ Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
        function updateMealCards(mealsData, selectedIds) {
            try {
                //Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½
                allMealsData = mealsData;
                
                // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Ï‰Î½ ÎºÎ±ÏÏ„ÏÎ½ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½
                createMealCards(mealsData);
                
                updateSelectedCards(selectedIds);
                
            } catch (e) {
                showError(`Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±ÏÏ„ÏÎ½ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½: ${e.message}`);
                console.error(e);
            }
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Ï‰Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÎºÎ±ÏÏ„ÏÎ½ Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±
        function updateSelectedCards(selectedIds) {
            
            localSelections[currentDay] = selectedIds.slice(); 

            if (!allMealsData || allMealsData.length === 0) {
                extractMealDataFromDOM();
            }
            
            const mealCards = document.querySelectorAll('.meal-card');
            let cardsUpdated = 0;
            mealCards.forEach(card => {
                const mealId = parseInt(card.dataset.mealId, 10);
                if (selectedIds.includes(mealId)) {
                    card.classList.add('selected');
                    cardsUpdated++;
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Î•Î½Î·Î¼ÎµÏÏ‰ÏƒÎ· Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½ ÎºÎ±Î¹ Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½
            updateDailyCaloriesDisplay(); 
            updateMacroNutrientDisplays();
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï Ï„Î·Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ Î·Î¼Î­ÏÎ±Ï‚
        function updateSelectedDayButton(day) {
            const dayBtns = document.querySelectorAll('.day-btn');
            dayBtns.forEach(btn => {
                if (btn.dataset.day === day) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function createMealCards(meals) {
            const container = document.getElementById('mealContainer');
            if (!container) {
                showError('Meal container element not found!');
                return; // Î£Ï„Î¿Ï€ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿ container
            }
            container.innerHTML = '';

            if (!Array.isArray(meals)) {
                 showError(`createMealCards received non-array input: ${typeof meals}`);
                 return; // Î£Ï„Î¿Ï€ Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï€Î¯Î½Î±ÎºÎ±Ï‚
            }

            if (meals.length>0) {
            }

            meals.forEach((meal,index)=>{
                try {
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    mealCard.dataset.mealId = meal.id;

                    if (!meal.name || meal.id === undefined) {
                        showError(`Meal at index ${index} is missing name or id property - skipping`);
                        return; // Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ· Î³ÎµÏÎ¼Î±Ï„Î¿Ï‚ Î±Î½ Î»ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Î® Ï„Î¿ ID
                    }

                    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î­Î³ÎºÏ…ÏÎ± Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±
                    const hasValidMacros = 
                        meal.protein !== null && meal.protein !== undefined && 
                        meal.carbs !== null && meal.carbs !== undefined && 
                        meal.fat !== null && meal.fat !== undefined;
                    
                    mealCard.innerHTML = `
                        <h3>${meal.name}</h3>
                        <img class='meal-image' src='${meal.imageUrl || 'https://via.placeholder.com/200x150?text=No+Image'}' onerror="this.onerror=null; this.src='https://via.placeholder.com/200x150?text=No+Image';">
                        <div class="stats-row">
                            <span class="stats-text">${meal.calories !== null && meal.calories !== undefined ? `${Math.round(meal.calories)} kcal` : 'Calories N/A'}</span>
                            <span class="stats-text">${meal.servingWeight !== null && meal.servingWeight !== undefined ? `${meal.servingWeight}g` : ''}</span>
                        </div>
                        <p class="nutrients ${hasValidMacros ? '' : 'unavailable'}">
                            ${hasValidMacros ? 
                                `Protein: ${meal.protein.toFixed(1)}g | Carbs: ${meal.carbs.toFixed(1)}g | Fat: ${meal.fat.toFixed(1)}g` : 
                                'Nutrition data unavailable'}
                        </p>
                        <div class="tags">
                            ${meal.vegan ? '<div class="tag vegan-tag">Vegan</div>' : ''}
                            ${meal.vegetarian ? '<div class="tag vegetarian-tag">Vegetarian</div>' : ''}
                            ${meal.glutenFree ? '<div class="tag gf-tag">Gluten Free</div>' : ''}
                            ${meal.dairyFree ? '<div class="tag df-tag">Dairy Free</div>' : ''}
                            ${meal.veryHealthy ? '<div class="tag healthy-tag">Healthy</div>' : ''}
                            ${meal.cheap ? '<div class="tag cheap-tag">Budget</div>' : ''}
                            ${meal.sustainable ? '<div class="tag eco-tag">Eco</div>' : ''}
                            ${meal.lowFodmap ? '<div class="tag fodmap-tag">Low FODMAP</div>' : ''}
                        </div>
                    `;
                    
                    container.appendChild(mealCard);
                } catch (e) {
                    showError(`Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¬ÏÏ„Î±Ï‚ Î³ÎµÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î· Î¸Î­ÏƒÎ· ${index}: ${e.message}`);
                    if (meal) {
                    }
                }
            });
        }

        // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±    
        function updateDailyCaloriesDisplay() {
            const selectedMeals = localSelections[currentDay] || [];
            let totalSelectedCalories = 0;
            
            // Î†ÏÎ¿Î¹ÏƒÎ¼Î± Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½ Î±Ï€ÏŒ ÏŒÎ»Î± Ï„Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î± Î³ÎµÏÎ¼Î±Ï„Î±
            selectedMeals.forEach(mealId => {
                const meal = allMealsData.find(m => m.id === mealId);
                if (meal && meal.calories) {
                    totalSelectedCalories += meal.calories;
                } else {
                    showError(`Could not find meal data for ID ${mealId} or missing calories`);
                }
            });
            
            // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎµÎ½Î±Ï€Î¿Î¼ÎµÎ¹Î½Î¿Ï…ÏƒÏÎ½ Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½
            const remainingCalories = DEFAULT_DAILY_CALORIES - totalSelectedCalories;
            
            // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±
            dailyCalories[currentDay] = remainingCalories;
            
            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚ Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½
            const calorieValue = document.querySelector('.calorie-value');
            const calorieLabel = document.querySelector('.calorie-label');
            
            if (calorieValue && calorieLabel) {
                calorieValue.classList.remove('over', 'warning');
                
                if (remainingCalories < 0) {
                    // Î‘ÏÎ½Î·Ï„Î¹ÎºÎ­Ï‚ Î¸ÎµÏÎ¼Î¯Î´ÎµÏ‚ (Ï…Ï€ÎµÏÎ²Î¿Î»Î®)
                    calorieValue.textContent = Math.abs(Math.round(remainingCalories));
                    calorieLabel.textContent = 'kcal Over';
                    calorieValue.classList.add('over');
                } else {
                    // ÎœÎµÏƒÎ± ÏƒÏ„Î¿ ÏŒÏÎ¹Î¿
                    calorieValue.textContent = Math.round(remainingCalories);
                    calorieLabel.textContent = 'kcal Remaining';
                    
                    // Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½ ÎµÎ½Î±Ï€Î¿Î¼ÎµÎ¯Î½Î¿Ï…ÏƒÎµÏ‚ Î¸ÎµÏÎ¼Î¯Î´ÎµÏ‚ <= 100
                    if (remainingCalories <= 100) {
                        calorieValue.classList.add('warning');
                    }
                }
            }

            console.log(`Updated calories for ${currentDay}: Total selected: ${totalSelectedCalories}, Remaining: ${remainingCalories}`);
        }

        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±
        function updateMacroNutrientDisplays() {
            // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±
            const selectedMeals = localSelections[currentDay] || [];
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            
            // Î‘ÏÎ¿Î¹ÏƒÎ¼Î± Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î±Ï€ÏŒ ÏŒÎ»Î± Ï„Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î± Î³ÎµÏÎ¼Î±Ï„Î±
            selectedMeals.forEach(mealId => {
                const meal = allMealsData.find(m => m.id === mealId);
                if (meal) {
                    if (meal.protein) {
                        totalProtein += meal.protein;
                    }
                    if (meal.carbs) {
                        totalCarbs += meal.carbs;
                    }
                    if (meal.fat) {
                        totalFat += meal.fat;
                    }
                } else {
                    showError(`Could not find meal data for macro calculation: ID ${mealId}`);
                }
            });
            
            // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î³Î¹Î± Ï„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î·Î¼Î­ÏÎ±
            dailyProtein[currentDay] = totalProtein;
            dailyCarbs[currentDay] = totalCarbs;
            dailyFat[currentDay] = totalFat;
            
            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¹Î¼ÏÎ½ Î³Î¹Î± Î ÏÏ‰Ï„ÎµÎÎ½Î·, Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚ ÎºÎ±Î¹ Î›Î¯Ï€Î¿Ï‚
            const proteinDisplay = document.querySelector('.macro-pill.protein .macro-value');
            if (proteinDisplay) {
                proteinDisplay.classList.remove('met', 'not-met');
                proteinDisplay.textContent = `${Math.round(totalProtein)}g/${Math.round(DEFAULT_PROTEIN_GOAL)}g`;


                if (totalProtein >= DEFAULT_PROTEIN_GOAL) {
                    proteinDisplay.classList.add('met');
                } else {
                    proteinDisplay.classList.add('not-met');
                }
            }

            const carbsDisplay = document.querySelector('.macro-pill.carbs .macro-value');
            if (carbsDisplay) {
                carbsDisplay.classList.remove('met', 'not-met');
                carbsDisplay.textContent = `${Math.round(totalCarbs)}g/${Math.round(DEFAULT_CARBS_GOAL)}g`;
                
                if (totalCarbs >= DEFAULT_CARBS_GOAL) {
                    carbsDisplay.classList.add('met');
                } else {
                    carbsDisplay.classList.add('not-met');
                }
            }

            const fatDisplay = document.querySelector('.macro-pill.fat .macro-value');
            if (fatDisplay) {
                fatDisplay.classList.remove('met', 'not-met');
                fatDisplay.textContent = `${Math.round(totalFat)}g/${Math.round(DEFAULT_FAT_GOAL)}g`;
                
                if (totalFat >= DEFAULT_FAT_GOAL) {
                    fatDisplay.classList.add('met');
                } else {
                    fatDisplay.classList.add('not-met');
                }
            }
            
            console.log(`Updated macros for ${currentDay}: Protein: ${totalProtein}g, Carbs: ${totalCarbs}g, Fat: ${totalFat}g`);
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½ Î±Ï€ÏŒ Ï„Î·Î½ Java
        function handleMessageFromJava(messageString) {
            try {
                console.log('ğŸ“¨ Received message from Java:', messageString);
                const messageObject = JSON.parse(messageString);
                
                // Î”Î¹Î±Î³Î½Ï‰ÏƒÏ„Î¹ÎºÏŒ Î¼Î®Î½Ï…Î¼Î±
                if (messageObject.action === 'selectDay') {
                    // Î‘Î»Î»Î±Î³Î® Î·Î¼Î­ÏÎ±Ï‚
                    const { day, selectedMealIds } = messageObject;
                    console.log(`ğŸ”„ Processing selectDay for ${day} with meal IDs from Java:`, selectedMealIds);
                    
                    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÏÎ½ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î·Î¼Î­ÏÎ±
                    localSelections[day] = selectedMealIds || [];

                    currentDay = day;
                    updateSelectedDayButton(day);

                    setTimeout(() => {
                        updateSelectedCards(selectedMealIds || []);
                        updateDailyCaloriesDisplay();
                        updateMacroNutrientDisplays();
                    }, 100);
                }
            } catch (e) {
                showError(`Failed to parse message from Java: ${e.message}`);
                console.error('Raw message:', messageString);
            }
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½ ÏƒÏ„Î·Î½ Java
        function sendMessageToJava(messageObject) {
            console.log(`ğŸ”§ sendMessageToJava called with:`, messageObject);
            console.log(`ğŸ”§ Bridge status: ${bridge ? 'EXISTS' : 'NULL'}`);
            if (bridge) {
                try {
                    const messageString = JSON.stringify(messageObject);
                    bridge.postMessage(messageString);
                } catch (e) {
                    console.error(`âŒ Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î·Î½ Java: ${e.message}`);
                }
            } else {
                showError('Î— Î³Î­Ï†Ï…ÏÎ± JavaFX Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·');
            }
        }

        // Î Î¬ÏÎµ Ï„Î± Î±ÏÏ‡Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î·Î½ Java
        function requestInitialData() {
            sendMessageToJava({ action: 'getInitialData' });
        }

        // Bridge initialization
        function initializeBridge() {
            try {
                if (window.bridge) {
                    bridge = window.bridge;
                } else {
                    showError('Î— Î³Î­Ï†Ï…ÏÎ± JavaFX Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·');
                }
            } catch (e) {
                showError(`Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Î³Î­Ï†Ï…ÏÎ±Ï‚: ${e.message}`);
            }
        }

        // Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Ï„Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î¼Îµ Ï€ÏÎ¿-Ï€Î±ÏÎ±Î³Î¼Î­Î½Î¿ HTML Î±Ï€ÏŒ Ï„Î·Î½ Java
        function setupPageWithHtml(initialDay, initialSelectedIds, allSelectedIds, targetCalories, proteinGoal, carbsGoal, fatGoal) {  
            // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÏÎ½ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½
            if (allSelectedIds) {  
                try {  
                    if (typeof allSelectedIds === 'object') {
                        localSelections = allSelectedIds;
                    } else {
                        localSelections = parseJSONorArray(allSelectedIds);
                    }  
                } catch (e) {  
                    showError('Failed parsing allSelectedIds in setupPageWithHtml: ' + e.message);  
                }  
            }  
            
            if (!isNaN(proteinGoal)) DEFAULT_PROTEIN_GOAL = proteinGoal;  
            if (!isNaN(carbsGoal)) DEFAULT_CARBS_GOAL = carbsGoal;  
            if (!isNaN(fatGoal)) DEFAULT_FAT_GOAL = fatGoal;  
            if (targetCalories && !isNaN(targetCalories)) {  
                DEFAULT_DAILY_CALORIES = targetCalories;  
                console.log(" Default daily calories set from Java:", DEFAULT_DAILY_CALORIES);  
            } else {  
                console.warn(" No target calories received, using default 2000 kcal");  
            }              
            try {  
                localSelections[initialDay] = parseJSONorArray(initialSelectedIds);  
  
                currentDay = initialDay;  
  
                // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡Î¹ÎºÎ­Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î·Î¼Î­ÏÎ±, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Ï„Ï…Ï‡Î±Î¯ÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î·Î¼Î­ÏÎµÏ‚
                if (!Array.isArray(initialSelectedIds) || parseJSONorArray(initialSelectedIds).length === 0) {
                    generateRandomSelections();
                }
                currentDay = initialDay;
  
                extractMealDataFromDOM();  
                
                updateSelectedCards(localSelections[initialDay]);  
                updateSelectedDayButton(currentDay);  
  
                updateDailyCaloriesDisplay();  
                updateMacroNutrientDisplays();  
  
            } catch (e) {  
                showError(`Error during setupPageWithHtml: ${e.message}`);  
                console.error(e);  
            }  
        }  

        // Î²Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® Î³Î¹Î± parsing Ï€ÎµÎ´Î¯Ï‰Î½ Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ string Î® array
        function parseJSONorArray(input) {
            if (typeof input === 'string') {
                try {
                    return JSON.parse(input);
                } catch (e) {
                    showError(`Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î®Ï‚ Î±Ï€ÏŒ string: ${e.message}`);
                    return [];
                }
            }
            return Array.isArray(input) ? input : [];
        }

        function extractMealDataFromDOM() {
            try {
                allMealsData = []; // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ array
                const mealCards = document.querySelectorAll('.meal-card');

                mealCards.forEach(card => {
                    const mealId = parseInt(card.dataset.mealId, 10);
                    const nameElement = card.querySelector('h3');
                    const caloriesElement = card.querySelector('.stats-row .stats-text:first-child');
                    const nutrientsElement = card.querySelector('.nutrients');

                    if (!isNaN(mealId) && nameElement) {
                        const meal = {
                            id: mealId,
                            name: nameElement.textContent.trim()
                        };

                        // Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· Î¸ÎµÏÎ¼Î¯Î´Ï‰Î½
                        if (caloriesElement && caloriesElement.textContent.includes('kcal')) {
                            const match = caloriesElement.textContent.match(/(\d+)/);
                            if (match) {
                                meal.calories = parseInt(match[1], 10);
                            }
                        }

                        // Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· macros
                        if (nutrientsElement && !nutrientsElement.classList.contains('unavailable')) {
                            const nutrientsText = nutrientsElement.textContent;

                            const proteinMatch = nutrientsText.match(/Protein:\s*([\d.]+)g/);
                            if (proteinMatch) {
                                meal.protein = parseFloat(proteinMatch[1]);
                            }

                            const carbsMatch = nutrientsText.match(/Carbs:\s*([\d.]+)g/);
                            if (carbsMatch) {
                                meal.carbs = parseFloat(carbsMatch[1]);
                            }

                            const fatMatch = nutrientsText.match(/Fat:\s*([\d.]+)g/);
                            if (fatMatch) {
                                meal.fat = parseFloat(fatMatch[1]);
                            }
                        }

                        allMealsData.push(meal);
                    }
                });

                console.log(" allMealsData:", allMealsData);
            } catch (e) {
                showError(` Failed to extract meal data from DOM: ${e.message}`);
                console.error(e);
            }
        }

        // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ ÏŒÏ„Î±Î½ Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï„Î¿ DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM Content Loaded - Initializing page');
            
            // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Ï‰Î½ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½
            initLocalSelections();

            // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î­Ï†Ï…ÏÎ±Ï‚
            initializeBridge();
            
            // Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î±ÎºÏÎ¿Î±Ï„ÏÎ½ ÏƒÏ…Î¼Î²Î¬Î½Ï„Ï‰Î½
            setupEventListeners();
        });
        
        let isPageInitialized = false;

        function setupEventListeners() {
            if (isPageInitialized) return;
            isPageInitialized = true;
            
            console.log('ğŸ¯ Setting up event listeners');
            
            // Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚
            const searchInput = document.querySelector('.search-container input');
            if (searchInput) {
                let searchTimeout;
                // Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const query = searchInput.value.trim();
                        if (query.length >= 2) {
                            sendMessageToJava({ 
                                action: 'searchMeals', 
                                query: query 
                            });
                        } else if (query === '') {
                            sendMessageToJava({ action: 'getInitialData' });
                        }
                    }, 300);
                });
            }
            
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ Î³Ï…ÏÎ¹ÏƒÎ¼Î¿Ï Ï€Î¯ÏƒÏ‰
            const dayBtns = document.querySelectorAll('.day-btn');
            console.log(`ğŸ”˜ Found ${dayBtns.length} day buttons`);
            
            dayBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const selectedDay = btn.dataset.day;
                    console.log(`ğŸ–±ï¸ Day button clicked: ${selectedDay}, current: ${currentDay}`);
                    
                    if (selectedDay === currentDay) {
                        console.log(`ğŸ”„ Same day clicked, returning`);
                        return; // ÎœÎ·Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï„Î¯Ï€Î¿Ï„Î± Î±Î½ Î· Î·Î¼Î­ÏÎ± ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·
                    }

                    currentDay = selectedDay;
                    updateSelectedDayButton(currentDay);
                    console.log(`ğŸ“… Day changed to: ${currentDay}`);
                    
                    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏ€Î±ÏÎ¾Î·Ï‚ Î³Î­Ï†Ï…ÏÎ±Ï‚
                    console.log(`ğŸŒ‰ Bridge status: ${bridge ? 'Available' : 'Not available'}`);
                    
                    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Java Î¼Îµ Ï„Î·Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î·Î¼Î­ÏÎ±
                    console.log(`ğŸ“¤ Sending selectDay message to Java: ${currentDay}`);
                    sendMessageToJava({ action: 'selectDay', day: currentDay });
                    // Î¤Î¿Ï€Î¹ÎºÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÎµ dev mode
                    if (!bridge) {
                       updateSelectedCards(localSelections[currentDay]);
                       updateDailyCaloriesDisplay();
                       updateMacroNutrientDisplays();
                   }
                });
            });

            const finishBtn = document.querySelector('.finish-btn');
            if (finishBtn) {
                finishBtn.addEventListener('click', () => {
                    if (!allMealsData || allMealsData.length === 0) {
                        extractMealDataFromDOM();
                    }
                    const planByName = {};

                    Object.entries(localSelections).forEach(([day, ids]) => {
                        planByName[day] = ids.map(id => {
                            const meal = allMealsData.find(m => m.id === id);
                            return meal && meal.name ? meal.name : `Meal ${id}`;
                        });
                    });

                    const planSummary = encodeURIComponent(JSON.stringify(planByName));
                    window.location.href = `finalplan.html?plan=${planSummary}`;
                });
            }

            const mealContainer = document.getElementById('mealContainer');
            if (mealContainer) {
                mealContainer.addEventListener('click', (e) => {
                    const card = e.target.closest('.meal-card');
                    if (!card) return;

                    const mealId = parseInt(card.dataset.mealId, 10);
                    if (isNaN(mealId)) {
                        showError('Clicked card is missing a valid meal ID.');
                        return;
                    }

                    // Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î»Î¯ÏƒÏ„Î± Î³ÎµÏ…Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î· Î¼Î­ÏÎ±
                    let selected = localSelections[currentDay] || [];
                    const index = selected.indexOf(mealId);

                    if (index === -1) {
                        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î³ÎµÏÎ¼Î±Ï„Î¿Ï‚ 
                        selected.push(mealId);
                    } else {
                        // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î³ÎµÏÎ¼Î±Ï„Î¿Ï‚
                        selected.splice(index, 1);
                    }

                    localSelections[currentDay] = selected;

                    // ÎŸÏ€Ï„Î¹ÎºÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
                    updateSelectedCards(localSelections[currentDay]);

                    sendMessageToJava({
                        action: 'toggleMealSelection',
                        day: currentDay,
                        mealId: mealId
                    });
                   // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÏÎ½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏÎ½ Î³Î¹Î± Î¸ÎµÏÎ¼Î¯Î´ÎµÏ‚ ÎºÎ±Î¹ Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÎ¬
                   if (!bridge) {
                       updateDailyCaloriesDisplay();
                       updateMacroNutrientDisplays();
                   }
                });
            }
            
            console.log('âœ… All event listeners set up successfully');
        }
    </script>
</body>
</html>